<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>管理员列表</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link type="text/css" rel="stylesheet" href="/static/layui/css/layui.css"/>
    <link type="text/css" rel="stylesheet" href="/static/scrollbar/jquery.scrollbar.css"/>
    <link type="text/css" rel="stylesheet" href="/static/admin/iconfont/iconfont.css"/>
    <link type="text/css" rel="stylesheet" href="/static/admin/css/page-item.css"/>

    <style>
        .box_parent {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .layui-table-cell {
            height: 50px;
            line-height: 50px;
        }
    </style>
</head>
<body>
<div class="page-main scrollbar-inner">
    <div class="page-container">
        <div class="page-fluid">
            <form class="layui-form layui-unselect table-form" action="">
                <div class="layui-inline">
                    <label class="layui-form-label">国家</label>
                    <div class="layui-input-inline">
                        <select name="country">
                            <option value="">请选择</option>
                            <option value="日本">日本</option>
                            <option value="意大利">意大利</option>
                            <option value="英国">英国</option>
                            <option value="美国">美国</option>
                            <option value="法国">法国</option>
                            <option value="斯洛文尼亚">斯洛文尼亚</option>
                            <option value="捷克">捷克</option>
                            <option value="克罗地亚">克罗地亚</option>
                            <option value="德国">德国</option>
                            <option value="西班牙">西班牙</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">二维码内容</label>
                    <div class="layui-input-inline">
                        <input type="text" placeholder="二维码内容" name="qr_content" autocomplete="off"
                               class="layui-input"/>
                    </div>

                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">备注</label>
                    <div class="layui-input-inline">
                        <input type="text" placeholder="请输入备注" name="mark" autocomplete="off"
                               class="layui-input"/>
                    </div>

                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">范围日期</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input test-item" placeholder="yyyy-MM-dd HH:mm:ss"
                               name="date_start">
                    </div>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input test-item" placeholder="yyyy-MM-dd HH:mm:ss"
                               name="date_end">
                    </div>
                </div>
                {% if request.session.user.role == 0 %}
                    {% comment %} <div class="layui-inline">
                        <label class="layui-form-label">上传人</label>
                        <div class="layui-input-inline">
                            <select name="op_user_select" lay-search="">
                                <option value="">直接选择或搜索选择</option>
                            </select>
                        </div>
                    </div>{% endcomment %}
                    <div class="layui-inline">
                        <label class="layui-form-label">上传人</label>
                        <div class="layui-input-inline">
                            <input type="text" placeholder="上传人用户名关键字" name="op_username" autocomplete="off"
                                   lay-verify="op_username"
                                   class="layui-input"/>
                        </div>
                    </div>
                {% endif %}
                <div class="layui-inline">
                    <label class="layui-form-label">状态</label>
                    <div class="layui-input-inline">
                        <select name="used">
                            <option value="">请选择</option>
                            <option value="0">未使用</option>
                            <option value="1">已使用</option>
                            <option value="2">无效</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <button type="button" lay-filter="search" lay-submit class="layui-btn" data-type="reload">搜索
                    </button>
                </div>
            </form>

            <table id="list" lay-filter="list"></table>

        </div>
    </div>
</div>

<script type="text/javascript" src="/static/admin/iconfont/iconfont.js"></script>
<script type="text/javascript" src="/static/jquery/jquery-3.4.1.js"></script>
<script type="text/javascript" src="/static/admin/js/common.js"></script>
<script type="text/javascript" src="/static/scrollbar/jquery.scrollbar.min.js"></script>
<script type="text/javascript" src="/static/layui/layui.js"></script>
<script type="text/javascript" src="/static/admin/js/user_form.js"></script>
<script type="text/javascript" src="/static/admin/js/utils.js"></script>


{% comment %} component {% endcomment %}

<script type="text/html" id="toolbar">
    <a class="layui-btn layui-btn-sm" lay-event="upload">上传</a>
    <a class="layui-btn layui-btn-sm" lay-event="batch_upload">批量上传</a>
{#    <a class="layui-btn layui-btn-sm" href="/api/wa_qr/export?back_type={{ back_type }}">全部批量导出</a>#}
    <a class="layui-btn layui-btn-sm" lay-event="dispatch">分配当日新增数据</a>
    <a class="layui-btn layui-btn-sm" lay-event="dispatch_all">分配所有未使用数据（管理员）</a>
    <a class="layui-btn layui-btn-sm" lay-event="batch_used_state">批量修改状态</a>
</script>

<script type="text/html" id="table_control">
    <a class="layui-btn layui-btn-xs layui-btn layui-btn-warm" lay-event="copy">复制</a>
    <a class="layui-btn layui-btn-xs layui-btn-primary" lay-event="edit">编辑</a>
    {% if request.session.user.role == 0 %}
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    {% endif %}
</script>

<script type="text/html" id="qr_image">
    <div>
        <img src="/media/{% verbatim %}{{ d.qr_path }}{% endverbatim %}"
             style="width: 50px; height: 50px;" class="table_img">
    </div>
</script>

{% comment %} Form {% endcomment %}
<div class="layui-row" id="addForm" style="display:none;">
    <div class="layui-col-md10">
        <form class="layui-form" action="" style="margin-top:20px" lay-filter="addForm">
            <div class="layui-form-item">
                <label class="layui-form-label required">ID<span style="color: red">*</span> </label>
                <div class="layui-input-block required">
                    <input type="text" name="account_id"
                           required lay-verify="account_id"
                           autocomplete="off" placeholder="请输入ID" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item" style="margin-top:40px">
                <div class="layui-input-block">
                    <button class="layui-btn  layui-btn-submit " lay-submit="" lay-filter="addSubmit">确认添加
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

{% comment %} 单个图片上传 {% endcomment %}
<div class="layui-upload" id="uploadDialog" style="display: none">
    <div class="box_parent">
        <div class="layui-upload-drag" id="upload" style="width: 300px">
            <i class="layui-icon"></i>
            <p>点击上传，或将文件拖拽到此处</p>
            <div class="layui-hide" id="uploadView">
                <hr>
                <img src="" alt="上传成功后渲染" style="max-width: 100px; max-height: 100px">
            </div>
        </div>
    </div>

    <br/>
    <br/>
    <br/>
    <button class="layui-btn  layui-btn-submit layui-btn-fluid " lay-submit="" id="btnUpload">确认上传</button>
</div>
{% comment %} 批量zip包上传 {% endcomment %}
<div class="layui-upload" id="batchUploadDialog" style="display: none;">
    <div class="box_parent">
        <div class="layui-upload-drag" id="batchUpload">
            <i class="layui-icon"></i>
            <p>点击上传，或将文件拖拽到此处 (zip)</p>
            <div class="layui-hide" id="batchUploadView">
                <hr>
                <span id="p_upload_preview" style="max-width: 196px"></span>
            </div>
        </div>
    </div>
    <br/>
    <br/>
    <button class="layui-btn  layui-btn-submit layui-btn-fluid" lay-submit="" id="btnBatchUpload">确认上传</button>
    <br/>
    <p style="align-content: center">若压缩包图片比较多，则需要多等待一会儿</p>
</div>

<div class="layui-row" id="editForm" style="display:none;">
    <div class="layui-col-md10">
        <form class="layui-form layui-from-pane" action="" style="margin-top:20px" lay-filter="editForm">
            <input type="hidden" name="id">
            <div class="layui-form-item">
                <label class="layui-form-label required">URL</label>
                <div class="layui-input-block required">
                    <input type="text" name="qr_content" disabled="disabled" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">国家</label>
                <div class="layui-input-inline">
                    <select name="country">
                        <option value="">请选择</option>
                        <option value="日本">日本</option>
                        <option value="意大利">意大利</option>
                        <option value="英国">英国</option>
                        <option value="美国">美国</option>
                        <option value="法国">法国</option>
                        <option value="斯洛文尼亚">斯洛文尼亚</option>
                        <option value="捷克">捷克</option>
                        <option value="克罗地亚">克罗地亚</option>
                        <option value="德国">德国</option>
                        <option value="西班牙">西班牙</option>
                    </select>
                </div>

            </div>
            <div class="layui-form-item">
                <label class="layui-form-label required">年龄</label>
                <div class="layui-input-block required">
                    <input type="number" name="age"
                           required
                           autocomplete="off" placeholder="请输入年龄" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label required">工作</label>
                <div class="layui-input-block required">
                    <input type="text" name="work"
                           required lay-verify="required"
                           autocomplete="off" placeholder="请输入工作"
                           class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label required">收入</label>
                <div class="layui-input-inline" style="width: 100px;">
                    <input type="number" name="money" placeholder="￥" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">状态</label>
                <div class="layui-input-inline">
                    <select name="used">
                        <option value="">不设置</option>
                        <option value="false">未使用</option>
                        <option value="true">已使用</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-block">
                        <textarea name="mark"
                                  placeholder="备注信息"
                                  class="layui-textarea"></textarea>
                </div>
            </div>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">链接备注</label>
                <div class="layui-input-block">
                    <input type="text" placeholder="请输入" name="link_mark" autocomplete="off"
                           class="layui-input"/>
                </div>

            </div>
            <div class="layui-form-item" style="margin-top:40px">
                <div class="layui-input-block">
                    <button class="layui-btn  layui-btn-submit " lay-submit="" lay-filter="editSubmit">确认修改
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="layui-row" id="batchUpdateUsedStateForm" style="display: none;">
    <div class="layui-col-md12">
        <form class="layui-form layui-from-pane" action="" style="margin-top:20px"
              lay-filter="batchUpdateUsedStateForm">
            <div class="layui-inline">
                <label class="layui-form-label">状态</label>
                <div class="layui-input-inline">
                    <select name="used">
                        <option value="">不设置</option>
                        <option value="0">未使用</option>
                        <option value="1">已使用</option>
                        <option value="2">无效</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item" style="margin-top:40px">
                <div class="layui-input-block">
                    <button class="layui-btn  layui-btn-submit " lay-submit="" lay-filter="usedSubmit">确认修改
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="layui-row" id="exportDataWithType" style="display: none;">
    <div class="layui-col-md12">
        <form class="layui-form layui-from-pane" action="" style="margin-top:20px"
              lay-filter="exportDataWithType">
            <div class="layui-inline">
                <label class="layui-form-label">导出数据状态</label>
                <div class="layui-input-inline">
                    <select name="exportType">
                        <option value="0">全部</option>
                        <option value="1">已使用</option>
                        <option value="2">未使用</option>
                        <option value="3">无效</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item" style="margin-top:40px">
                <div class="layui-input-block">
                    <button class="layui-btn  layui-btn-submit " lay-submit="" lay-filter="handleExport">确认导出
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% comment %} {% endcomment %}
{% csrf_token %}
<script type="text/javascript">
    layui.config({
        base: '/static/layui/ext/'
    })
    layui.use(['layer', 'form', 'table', 'laytpl', 'laydate', 'upload'], function () {
            const layer = layui.layer,
                form = layui.form;
            const table = layui.table;
            const laydate = layui.laydate;
            const laytpl = layui.laytpl;
            const upload = layui.upload
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const headers = {
                "Accept": "application/json; charset=utf-8",
                "X-CSRFToken": csrftoken
            };

            lay('.test-item').each(function () {
                const date = new Date()
                const max = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()} ${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`
                laydate.render({
                    elem: this,
                    type: 'datetime',
                    min: '2023-1-1 00:00:00',
                    max: max
                    , trigger: 'click'
                });
            });
            var globalCurrentPage = 1;
            let op_col_width = 120
            {% if request.session.user.role == 0 %}
                op_col_width = 180
            {% endif %}
            /*表格渲染*/
            table.render({
                id: 'list',
                elem: '#list',
                url: '/api/wa_qr/list?back_type={{ back_type }}',
                page: true,
                toolbar: '#toolbar',
                cellMinWidth: 80,
                cols: [[
                    {type: 'checkbox', fixed: 'left'},
                    {field: 'id', title: '编号', width: 70, align: 'center'},
                    {field: 'qr_content', title: '二维码内容', align: 'center', minWidth: 340},
                    {field: 'qr_path', title: '二维码', align: 'center', templet: '#qr_image', event: 'preview'},
                    {field: 'country', title: '国家', align: 'center', sort: true, minWidth: 80},
                    {field: 'used', title: '使用状态', align: 'center', sort: true, templet: usedTemplate, minWidth: 110},

                    {% if request.session.user.role == 0 %}
                        {field: 'op_user__username', title: '上传人', align: 'center', sort: true, minWidth: 120},
                    {% endif %}
                    {field: 'mark', title: '备注', align: 'center', minWidth: 220},
                    {
                        field: 'is_bind',
                        title: '绑定状态',
                        align: 'center',
                        sort: true,
                        templet: bindTemplate,
                        minWidth: 110
                    },
                    {field: 'age', title: '年龄', align: 'center', sort: true, minWidth: 80},
                    {field: 'work', title: '工作', align: 'center'},
                    {field: 'money', title: '收入', align: 'center', sort: true},
                    {field: 'create_time', title: '上传时间', align: 'center', sort: true, minWidth: 160},
                    {field: 'update_time', title: '更新时间', minWidth: 160, align: 'center', sort: true},
                    {field: 'action', title: '操作', fixed: 'right', toolbar: '#table_control', width: op_col_width}
                ]],
                defaultToolbar: ['filter',
                //    {
                 //       title: '导出' //标题
                  //      , layEvent: 'custom_export' //事件名，用于 toolbar 事件中使用
                   //     , icon: 'layui-icon-export' //图标类名
                   // },
                ],
                done: function (res, curr, count) {
                    globalCurrentPage = curr
                }
            });

            /*表格头工具监听*/
            table.on('toolbar(list)', function (obj) {
                const data = obj.data; //获得当前行数据
                const layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
                if (layEvent === 'upload') {
                    initUpload();
                } else if (layEvent === 'batch_upload') {
                    initBatchUpload()
                } else if (layEvent === 'batch_export') {
                    handleExport()
                } else if (layEvent === 'custom_export') {
                    console.log("自定义导出");
                    let checkStatus = table.checkStatus('list')
                    let checkData = checkStatus.data
                    console.log("checkData = ", typeof checkData)
                    const ids = checkData.map((item) => item.id)
                    if (ids.length === 0) {
                        layer.msg("导出失败，请选择要导出的行", {icon: 5})
                        return
                    }
                    exportByIds(ids)
                } else if (layEvent === 'dispatch') {
                    handleDispatch();
                } else if (layEvent === 'dispatch_all') {
                    handleDispatch(true);
                } else if (layEvent === 'batch_used_state') {
                    let checkStatus = table.checkStatus(obj.config.id);
                    handleBatchUsedState(checkStatus)
                }
            });

            /*表格行工具监听*/
            table.on('tool(list)', function (obj) {
                const layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
                if (layEvent === 'edit') {
                    layer.open({
                        type: 1,
                        title: "修改数据",
                        area: ['600px', '600px'],
                        content: $("#editForm")
                    });
                    initEditForm(obj);
                } else if (layEvent === 'del') {
                    handleDel(obj);
                } else if (layEvent === 'copy') {
                    const text = obj.data.qr_content
                    {% comment %}if (navigator.clipboard) {
                         navigator.clipboard.writeText(text);
                     } else {

                     }{% endcomment %}
                    const copyipt = document.createElement("input");
                    copyipt.setAttribute("value", text);
                    document.body.appendChild(copyipt);
                    copyipt.select();
                    document.execCommand("copy");
                    document.body.removeChild(copyipt);
                    layer.msg("复制成功，内容为：" + text, {icon: 6});
                } else if (layEvent === 'preview') {
                    previewImg(obj);
                } else {
                    console.log(layEvent)
                }
            });

            function initSearchForm() {
                form.on('submit(search)', function (data) {
                    table.reload('list', {
                        page: {
                            curr: 1 //重新从第 1 页开始
                        },
                        where: data.field
                    });
                    return false;
                });
                form.render();
            }

            initSearchForm();

            function initAddForm() {
                form.on('submit(addSubmit)', function (massage) {
                    console.log(massage)
                    layer.load();
                    $.ajax({
                        url: '/api/wa_qr/upload',
                        type: 'POST',
                        headers: headers,
                        data: {
                            ...massage.field,
                            "back_type":{{ back_type }}
                        },
                        success: function (res) {
                            if (res.code >= 0) {
                                console.log("添加成功")
                                layer.closeAll('loading');
                                layer.load(2);
                                layer.msg("添加成功", {icon: 6});
                                setTimeout(function () {
                                    table.reload("list", {
                                        page: {
                                            curr: globalCurrentPage
                                        }
                                    });
                                    layer.closeAll();//关闭所有的弹出层
                                }, 1000);
                            } else {
                                layer.msg(res.msg, {icon: 5})
                            }
                        },
                        error: function () {
                            layer.msg("请求失败", {icon: 5})
                        },
                    });
                    return false
                })

            }

            function initUpload() {
                let layerId = 0
                const batchUpload = upload.render({
                    elem: '#upload',
                    url: '/api/wa_qr/upload?back_type={{ back_type }}',
                    accept: 'images',
                    field: 'image',
                    headers: headers,
                    exts: 'jpg|png|bmp|jpeg',
                    auto: false,
                    data: {
                        'filename': 'test.txt',
                        "back_type":{{ back_type }}
                    },
                    size: 4096,
                    bindAction: '#btnUpload',
                    before: function (obj) {
                        layerId = layer.load()
                        console.log("upload before");
                    },
                    choose: function (obj) {
                        batchUpload.config.elem.next()[0].value = '';
                        console.log("upload choose", obj);
                        let files = obj.pushFile();
                        console.log("upload choose files = ", files)
                        obj.preview(function (index, file, result) {
                            $('#uploadView').removeClass('layui-hide').find('img').attr('src', result)
                            batchUpload.config.data.filename = file.name
                        });
                    },
                    done: function (res, index, upload) {
                        console.log(`upload done res = ${JSON.stringify(res)} index = ${index} upload = ${upload}`);
                        if (res.code < 0) {
                            layer.close(layerId);
                            layer.msg(res.msg, {icon: 5})
                            return
                        }
                        layer.close(layerId);
                        // layer.closeAll();//关闭所有的弹出层
                        table.reload('list', {
                            page: {
                                curr: 1 //重新从第 1 页开始
                            }
                        });
                        $('#uploadView').addClass('layui-hide');
                        layer.msg("上传成功", {icon: 6});
                    },
                    error: function (index, upload) {
                        console.log(`upload error index = ${index} upload = ${upload}`)
                        layer.msg("上传失败，请重试", {icon: 5})
                        // layer.closeAll('loading');
                        layer.close(layerId);
                    }
                });

                layer.open({
                    type: 1,
                    area: ['400px', '400px'],
                    title: ['二维码上传', 'text-align:center;'],
                    content: $("#uploadDialog"),
                    end: function () {
                        console.log("close upload")
                        $('#uploadView').addClass('layui-hide')
                        batchUpload.config.elem.next()[0].value = '';
                    }
                });
            }

            function initBatchUpload() {
                let layerId = 0;
                const batchUpload = upload.render({
                    elem: '#batchUpload',
                    url: '/api/wa_qr/bat_upload?back_type={{ back_type }}',
                    accept: 'file',
                    field: 'file',
                    headers: headers,
                    exts: 'zip',
                    auto: false,
                    size: 50 * 1024,
                    data: {
                        "back_type":{{ back_type }}
                    },
                    bindAction: '#btnBatchUpload',
                    before: function (obj) {
                        layerId = layer.load()
                        console.log("upload before");
                    },
                    choose: function (obj) {
                        batchUpload.config.elem.next()[0].value = '';
                        console.log("upload choose", obj);
                        let files = obj.pushFile();
                        console.log("upload choose files = ", files)
                        obj.preview(function (index, file, result) {
                            $('#batchUploadView').removeClass('layui-hide');
                            $('#p_upload_preview')[0].innerHTML = `文件：${file.name}`
                            batchUpload.config.data.filename = file.name
                        });
                    },
                    done: function (res, index, upload) {
                        console.log(`upload done res = ${JSON.stringify(res)} index = ${index} upload = ${upload}`);
                        if (res.code < 0) {
                            layer.close(layerId);
                            // layer.closeAll('loading');
                            layer.msg(res.msg, {icon: 5})
                            return
                        }
                        layer.close(layerId);
                        // layer.closeAll();//关闭所有的弹出层
                        table.reload('list', {
                            page: {
                                curr: 1 //重新从第 1 页开始
                            }
                        });
                        layer.msg("上传成功", {icon: 6});
                        handleDispatch();
                    },
                    error: function (index, upload) {
                        console.log(`upload error index = ${index} upload = ${upload}`)
                        layer.msg("上传失败，请重试", {icon: 5})
                        // layer.closeAll('loading');
                        layer.close(layerId);
                    }
                });

                layer.open({
                    type: 1,
                    area: ['400px', '350px'],
                    title: ['Zip压缩包上传', 'text-align:center;'],
                    content: $("#batchUploadDialog"),
                    end: function () {
                        $('#batchUploadView').addClass('layui-hide');
                        batchUpload.config.elem.next()[0].value = '';
                    }
                });
            }


            function initEditForm(obj) {
                const data = obj.data;
                $("#p_username").innerHTML = data.username;

                form.val("editForm", {
                    id: data.id,
                    qr_content: data.qr_content,
                    country: data.country,
                    age: data.age,
                    work: data.work,
                    money: data.money,
                    used: data.used + "",
                    mark: data.mark,
                    link_mark: data.link_mark,
                });

                form.on('submit(editSubmit)', function (massage) {
                    console.log("updatw = massage", massage)
                    layer.load(1);
                    $.ajax({
                        url: '/api/wa_qr/update?back_type={{ back_type }}',
                        type: 'POST',
                        headers: headers,
                        data: {
                            id: data.id,
                            ...massage.field,
                            "back_type": {{ back_type }}
                        },
                        success: function (res) {
                            if (res.code >= 0) {
                                console.log("修改成功")
                                layer.closeAll('loading');
                                layer.load(2);
                                layer.msg("修改成功", {icon: 6});
                                setTimeout(function () {
                                    layer.closeAll();//关闭所有的弹出层
                                    table.reload("list", {
                                        page: {
                                            curr: globalCurrentPage
                                        }
                                    });//修改成功修改表格数据不进行跳转
                                }, 1000);
                            } else {
                                layer.msg(res.code, {icon: 5});
                            }
                        }, error: function (err) {
                            console.log("修改失败：", JSON.stringify(err));
                            layer.msg("修改失败: 请求失败", {icon: 5});
                        }
                    });
                    return false
                });
            }

            function handleDel(obj) {
                layer.confirm('确定删除吗？', function (index) {
                    layer.close(index);
                    const index2 = layer.load(0);
                    $.ajax({
                        url: "/api/wa_qr/del?back_type={{ back_type }}",
                        data: {
                            id: obj.data.id, account_id: obj.data.account_id, back_type:{{back_type}}
                        },
                        type: "post",
                        headers: headers,
                        dataType: "JSON",
                        success: function (msg) {
                            if (msg.code === 0) {
                                layer.msg(msg.msg, {icon: 6});
                                setTimeout(function () {
                                    layer.closeAll();//关闭所有的弹出层2
                                    table.reload("list", {
                                        page: {
                                            curr: globalCurrentPage
                                        }
                                    });//修改成功修改表格数据不进行跳转
                                }, 1000);
                                return;
                            }
                            layer.msg(msg.msg, {icon: 5});
                        },
                        error: function () {
                            layer.closeAll();
                            layer.msg("请求失败", {icon: 5})
                        },
                        complete() {
                            layer.close(index2);
                        }
                    });
                });
            }

            function exportByIds(ids) {
                console.log("exportByIds#ids = ", ids);
                const xhr = new XMLHttpRequest();
                xhr.open('get', "/api/wa2/account_qr/export_select?ids=" + ids, true); // 也可以使用POST方式，根据接口
                xhr.responseType = "blob"; // 返回类型blob
                // 定义请求完成的处理函数，请求前也可以增加加载框/禁用下载按钮逻辑
                xhr.onload = function (e) {
                    // 请求完成
                    if (this.status === 200) {
                        // 返回200
                        const blob = new Blob([this.response], {
                            type: "application/vnd.ms-excel"
                        });
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        $("body").append(a); // 修复firefox中无法触发click
                        a.click();
                        $(a).remove();
                    } else if (this.status === 404 || this.status === 500) {
                        console.log("404 response = ", this.response)
                        layer.msg("导出失败，" + this.status, {icon: 5})
                    }
                };
                xhr.timeout = 1000 * 60 * 60; //将超时时间设置为1天
                xhr.ontimeout = function () { //请求终止时，会执行ontimeout事件处理程序
                    layer.msg("导出失败，请求超时", {icon: 5})
                }
                // 发送ajax请求
                xhr.send();
            }

            function handleExport() {

                console.log("handleExport")
                const xhr = new XMLHttpRequest();
                xhr.open('get', "/api/wa_qr/export?back_type={{ back_type }}", true);
                xhr.responseType = "blob"; // 返回类型blob
                // 定义请求完成的处理函数，请求前也可以增加加载框/禁用下载按钮逻辑
                xhr.onload = function (e) {
                    // 请求完成
                    if (this.status === 200) {
                        // 返回200
                        const blob = new Blob([this.response], {
                            type: "application/vnd.ms-excel"
                        });
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        $("body").append(a); // 修复firefox中无法触发click
                        a.click();
                        $(a).remove();
                    } else if (this.status === 404 || this.status === 500) {
                        console.log("404 response = ", this.response)
                        layer.msg("导出失败，" + this.status, {icon: 5})
                    }
                };
                xhr.timeout = 1000 * 60 * 60; //将超时时间设置为1天
                xhr.ontimeout = function () { //请求终止时，会执行ontimeout事件处理程序
                    layer.msg("导出失败，请求超时", {icon: 5})
                }
                // 发送ajax请求
                xhr.send();
            }

            function exportDataWithType() {
                layer.open({
                    type: 1,
                    title: "请选择",
                    area: ['400px', '300px'],
                    content: $("#exportDataWithType")
                });
                form.val("exportDataWithType", {
                    exportType: "0"
                });

                form.on('submit(usedSubmit)', function (massage) {
                    let exportType = massage.field.exportType
                    console.log("导出数据选择类型 = " + massage.field.exportType)
                    const xhr = new XMLHttpRequest();
                    xhr.open('get', "/api/wa_qr/export?back_type={{ back_type }}&export_type=" + exportType, true);
                    xhr.responseType = "blob"; // 返回类型blob
                    // 定义请求完成的处理函数，请求前也可以增加加载框/禁用下载按钮逻辑
                    xhr.onload = function (e) {
                        // 请求完成
                        if (this.status === 200) {
                            // 返回200
                            const blob = new Blob([this.response], {
                                type: "application/vnd.ms-excel"
                            });
                            const a = document.createElement('a');
                            a.href = URL.createObjectURL(blob);
                            $("body").append(a); // 修复firefox中无法触发click
                            a.click();
                            $(a).remove();
                        } else if (this.status === 404 || this.status === 500) {
                            console.log("404 response = ", this.response)
                            layer.msg("导出失败，" + this.status, {icon: 5})
                        }
                    };
                    xhr.timeout = 1000 * 60 * 60; //将超时时间设置为1天
                    xhr.ontimeout = function () { //请求终止时，会执行ontimeout事件处理程序
                        layer.msg("导出失败，请求超时", {icon: 5})
                    }
                    // 发送ajax请求
                    xhr.send();
                });
            }

            function handleDispatch(isAll = false) {
                layer.confirm('确定分发数据到用户吗？', function (index) {
                    layer.close(index);
                    const index2 = layer.load(0);
                    $.ajax({
                        url: "/api/wa_qr/dispatcher?back_type={{ back_type }}",
                        type: "post",
                        data: {
                            'isAll': isAll,
                            "back_type":{{ back_type }}
                        },
                        headers: headers,
                        dataType: "JSON",
                        success: function (msg) {
                            if (msg.code === 0) {
                                layer.msg(msg.msg, {icon: 6});
                                setTimeout(function () {
                                    layer.close(index2);
                                    table.reload("list", {
                                        page: {
                                            curr: 1
                                        }
                                    });
                                }, 1000);
                                return;
                            }
                            layer.msg(msg.msg, {icon: 5});
                        },
                        error: function () {
                            layer.msg("请求失败", {icon: 5})
                        },
                        complete() {
                            layer.close(index2);
                        }
                    });
                });
            }

            function previewImg(obj) {
                const img = new Image();
                let src = `/media/${obj.data.qr_path}`;
                img.src = src;
                console.log("src = ", src)
                const height = img.height + 50; //获取图片高度
                const width = img.width; //获取图片宽度
                const imgHtml = "<img src='" + src + "' width='100%' height='100%'/>";
                //弹出层
                layer.open({
                    type: 1,
                    shade: 0.8,
                    offset: 'auto',
                    area: ['500px', '500px'],
                    shadeClose: true,
                    scrollbar: false,
                    title: "图片预览", //不显示标题
                    content: imgHtml, //捕获的元素，注意：最好该指定的元素要存放在body最外层，否则可能被其它的相对元素所影响
                    cancel: function () {
                        //layer.msg('捕获就是从页面已经存在的元素上，包裹layer的结构', { time: 5000, icon: 6 });
                    }
                });
            }

            function handleBatchUsedState(checkStatus) {
                if (checkStatus.data.length === 0) {
                    layer.msg("请至少选择一个列表项", {icon: 5});
                    return
                }
                console.log("checkStatus = " + JSON.stringify(checkStatus))
                let ids = checkStatus.data.map((data) => data.id)
                layer.open({
                    type: 1,
                    title: "请选择状态",
                    area: ['400px', '300px'],
                    content: $("#batchUpdateUsedStateForm")
                });
                form.val("batchUpdateUsedStateForm", {
                    used: ""
                });

                form.verify({
                    used: function (value, item) {
                        if (value === "" || value === undefined) {
                            $(item).focus();
                            return "请选择一个状态"
                        }
                    }
                });
                form.on('submit(usedSubmit)', function (massage) {
                    console.log("updatw = massage", massage)
                    layer.load(1);
                    let formData = {
                        "used": massage.field.used,
                        "ids": ids.join(","),
                        "back_type": {{ back_type }}
                    }

                    $.ajax({
                        url: '/api/wa_qr/bat_used_update?back_type={{ back_type }}',
                        type: 'POST',
                        headers: headers,
                        data: formData,
                        success: function (res) {
                            if (res.code >= 0) {
                                console.log("修改成功")
                                layer.closeAll('loading');
                                layer.load(2);
                                layer.msg("修改成功", {icon: 6});
                                setTimeout(function () {
                                    layer.closeAll();//关闭所有的弹出层
                                    table.reload("list", {
                                        page: {
                                            curr: globalCurrentPage
                                        }
                                    });//修改成功修改表格数据不进行跳转
                                }, 1000);
                            } else {
                                layer.msg("修改失败", {icon: 5});
                            }
                        }
                    });
                    return false
                });
            }


            function usedTemplate(res) {
                if (res.used === 1) {
                    return `<span class="layui-badge layui-bg-green">已使用</span>`
                } else if (res.used === 2) {
                    return `<span class="layui-badge">无效</span>`
                } else {
                    return `<span class="layui-badge layui-bg-orange">未使用</span>`
                }
            }

            function bindTemplate(res) {
                if (res.is_bind) {
                    return `<span class="layui-badge layui-bg-blue">已绑定</span>`
                } else {
                    return `<span class="layui-badge layui-bg-gray">未绑定</span>`
                }
            }

            (function initUserList() {
                $.ajax({
                    url: '/api/user_simple_list',
                    success: function (res) {
                        if (res.code >= 0) {
                            let data = res.data;
                            let selectElements = $("select[name='op_user_select']");
                            for (let j = 0; j < selectElements.length; j++) {
                                for (let i = 0; i < data.length; i++) {
                                    let item = data[i];
                                    selectElements.eq(j).append(
                                        `<option value="${item.id}">${item.username}</option>`
                                    );
                                }
                            }
                            form.render('select');
                        } else {
                            console.log("策略列表，错误：", res.msg)
                        }
                    }
                });
            })();

            //滚动条
            jQuery(".page-main").scrollbar();


        }
    )
    ;
</script>
</body>
</html>