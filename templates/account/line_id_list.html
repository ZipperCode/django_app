{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>管理员列表</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link type="text/css" rel="stylesheet" href="{% static 'layui/css/layui.css' %}"/>
    <link type="text/css" rel="stylesheet" href="{% static 'scrollbar/jquery.scrollbar.css' %}"/>
    <link type="text/css" rel="stylesheet" href="{% static 'admin/iconfont/iconfont.css' %}"/>
    <link type="text/css" rel="stylesheet" href="{% static 'admin/css/page-item.css' %}"/>
    <style>
        .box_parent {
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
<div class="page-main scrollbar-inner">
    <div class="page-container">
        <div class="page-fluid">
            <form class="layui-form layui-unselect table-form" action="">
                <div class="layui-inline">
                    <label class="layui-form-label">ID</label>
                    <div class="layui-input-inline">
                        <input type="text" placeholder="请输入ID" autocomplete="off" name="account_id"
                               class="layui-input"/>
                    </div>

                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">国家</label>
                    <div class="layui-input-inline">
                        <select name="country">
                            <option value="">请选择</option>
                            <option value="日本">日本</option>
                            <option value="意大利">意大利</option>
                            <option value="英国">英国</option>
                            <option value="美国">美国</option>
                            <option value="法国">法国</option>
                            <option value="斯洛文尼亚">斯洛文尼亚</option>
                            <option value="捷克">捷克</option>
                            <option value="克罗地亚">克罗地亚</option>
                            <option value="德国">德国</option>
                            <option value="西班牙">西班牙</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">备注</label>
                    <div class="layui-input-inline">
                        <input type="text" placeholder="请输入备注" name="mark" autocomplete="off"
                               class="layui-input"/>
                    </div>

                </div>

                {% if request.session.user.role == 0 %}
                    {% comment %}<div class="layui-inline">
                        <label class="layui-form-label">上传人</label>
                        <div class="layui-input-inline">
                            <select name="op_user_select" lay-search="">
                                <option value="">直接选择或搜索选择</option>
                            </select>
                        </div>
                    </div>{% endcomment %}
                    <div class="layui-inline">
                        <label class="layui-form-label">范围日期</label>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input test-item" placeholder="yyyy-MM-dd HH:mm:ss"
                                   name="date_start">
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input test-item" placeholder="yyyy-MM-dd HH:mm:ss"
                                   name="date_end">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">上传人</label>
                        <div class="layui-input-inline">
                            <input type="text" placeholder="上传人用户名关键字" name="op_username" autocomplete="off"
                                   lay-verify="op_username"
                                   class="layui-input"/>
                        </div>

                    </div>
                {% endif %}
                <div class="layui-inline">
                    <label class="layui-form-label">状态</label>
                    <div class="layui-input-inline">
                        <select name="used">
                            <option value="">请选择</option>
                            <option value="0">未使用</option>
                            <option value="1">已使用</option>
                            <option value="2">无效</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <button type="button" lay-filter="search" lay-submit class="layui-btn" data-type="reload">搜索
                    </button>
                </div>
            </form>

            <table id="list" lay-filter="list"></table>

        </div>
    </div>
</div>

<script type="text/javascript" src="{% static 'admin/iconfont/iconfont.js' %}"></script>
<script type="text/javascript" src="{% static 'jquery/jquery-3.4.1.js' %}"></script>
<script type="text/javascript" src="{% static 'admin/js/common.js' %}"></script>
<script type="text/javascript" src="{% static 'scrollbar/jquery.scrollbar.min.js' %}"></script>
<script type="text/javascript" src="{% static 'layui/layui.js' %}"></script>
<script type="text/javascript" src="{% static 'admin/js/user_form.js' %}"></script>
<script type="text/javascript" src="{% static 'admin/js/utils.js' %}"></script>


{% comment %} component {% endcomment %}

<script type="text/html" id="toolbar">
    <a class="layui-btn layui-btn-sm" lay-event="upload">上传</a>
    <a class="layui-btn layui-btn-sm" lay-event="batch_upload">批量上传</a>
    {#    <a class="layui-btn layui-btn-sm" href="/api/account_id/export">全部批量导出</a>#}
    {#    <a class="layui-btn layui-btn-sm" lay-event="dispatch">分发当日新增数据</a>#}
    {#    <a class="layui-btn layui-btn-sm" lay-event="dispatch_all">分配所有未使用数据（管理员）</a>#}
    <a class="layui-btn layui-btn-sm" lay-event="dispatch">分配数据</a>
    <a class="layui-btn layui-btn-sm" lay-event="batch_used_state">批量修改状态</a>
</script>

<script type="text/html" id="table_control">
    <a class="layui-btn layui-btn-xs layui-btn layui-btn-warm" lay-event="copy">复制</a>
    <a class="layui-btn layui-btn-xs layui-btn-primary" lay-event="edit">编辑</a>
    {% if request.session.user.role == 0 %}
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    {% endif %}
</script>

{% comment %} Form {% endcomment %}
<div class="layui-row" id="addForm" style="display:none;">
    <div class="layui-col-md10">
        <form class="layui-form" action="" style="margin-top:20px" lay-filter="addForm">
            <div class="layui-form-item">
                <label class="layui-form-label required">ID<span style="color: red">*</span> </label>
                <div class="layui-input-block required">
                    <input type="text" name="account_id"
                           required lay-verify="account_id"
                           autocomplete="off" placeholder="请输入ID" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item" style="margin-top:40px">
                <div class="layui-input-block">
                    <button class="layui-btn  layui-btn-submit " lay-submit="" lay-filter="addSubmit">确认添加
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="layui-upload" id="uploadDialog" style="display: none">
    <div class="box_parent">
        <div class="layui-upload-drag" id="batchUpload">
            <i class="layui-icon"></i>
            <p>点击上传，或将文件拖拽到此处 (txt)</p>
            <div class="layui-hide" id="uploadDemoView">
                <hr>
                <span id="p_upload_preview" style="max-width: 196px"></span>
            </div>
        </div>
    </div>

    <br/>
    <br/>
    <br/>
    <button class="layui-btn  layui-btn-submit layui-btn-fluid" lay-submit="" id="btnBatchUpload">确认上传</button>
</div>

<div class="layui-row" id="batchUpdateUsedStateForm" style="display: none;">
    <div class="layui-col-md12">
        <form class="layui-form layui-from-pane" action="" style="margin-top:20px"
              lay-filter="batchUpdateUsedStateForm">
            <div class="layui-inline">
                <label class="layui-form-label">状态</label>
                <div class="layui-input-inline">
                    <select name="used">
                        <option value="">不设置</option>
                        <option value="0">未使用</option>
                        <option value="1">已使用</option>
                        <option value="2">无效</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item" style="margin-top:40px">
                <div class="layui-input-block">
                    <button class="layui-btn  layui-btn-submit " lay-submit="" lay-filter="usedSubmit">确认修改
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="layui-row" id="editForm" style="display:none;">
    <div class="layui-col-md10">
        <form class="layui-form layui-from-pane" action="" style="margin-top:20px" lay-filter="editForm">
            <input type="hidden" name="id">
            <div class="layui-form-item">
                <label class="layui-form-label required">ID</label>
                <div class="layui-input-block required">
                    <input type="text" name="account_id" lay-verify="account_id" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">国家</label>
                <div class="layui-input-inline">
                    <select name="country">
                        <option value="">请选择</option>
                        <option value="日本">日本</option>
                        <option value="意大利">意大利</option>
                        <option value="英国">英国</option>
                        <option value="美国">美国</option>
                        <option value="法国">法国</option>
                        <option value="斯洛文尼亚">斯洛文尼亚</option>
                        <option value="捷克">捷克</option>
                        <option value="克罗地亚">克罗地亚</option>
                        <option value="德国">德国</option>
                        <option value="西班牙">西班牙</option>
                    </select>
                </div>

            </div>
            <div class="layui-form-item">
                <label class="layui-form-label required">年龄</label>
                <div class="layui-input-block required">
                    <input type="number" name="age"
                           autocomplete="off" placeholder="请输入年龄" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label required">工作</label>
                <div class="layui-input-block required">
                    <input type="text" name="work" autocomplete="off" placeholder="请输入工作" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label required">收入</label>
                <div class="layui-input-inline" style="width: 100px;">
                    <input type="number" name="money" placeholder="￥" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">状态</label>
                <div class="layui-input-inline">
                    <select name="used">
                        <option value="">不设置</option>
                        <option value="0">未使用</option>
                        <option value="1">已使用</option>
                        <option value="2">无效</option>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label required">绑定状态</label>
                <div class="layui-input-inline">
                    <select name="is_bind">
                        <option value="0">不设置(未绑定)</option>
                        <option value="1">已绑定</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-block">
                    <textarea name="mark" placeholder="备注信息" class="layui-textarea"></textarea>
                </div>
            </div>

            <div class="layui-form-item" style="margin-top:40px">
                <div class="layui-input-block">
                    <button class="layui-btn  layui-btn-submit " lay-submit="" lay-filter="editSubmit">确认修改
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>


<div id="dispatchDialog" style="display: none">
    <div class="layui-row" style="margin-top: 30px">
        <div style="margin-left: 50px;margin-right: 50px;">
            <div class="layui-form-item">
                <label class="layui-form-label">搜索账号</label>
                <div class="layui-input-inline">
                    <input class="layui-input" name="dispatchId" id="dispatchReload" autocomplete="off"
                           placeholder="请输入账号进行模糊搜索">
                </div>
                <div class="layui-form-mid" style="padding: 0!important;">
                    <button class="layui-btn" data-type="reload" id="dispatchSearch">搜索</button>
                </div>
            </div>
            <table id="dispatchList" lay-filter="dispatchList" style="width: 100%"></table>

            <div>
                <form class="layui-form layui-form-pane" action="" lay-filter="dispatchForm">
                    <div class="layui-form-item">
                        <label class="layui-form-label">用户选择</label>
                        <div class="layui-input-block">
                            <select name="dispatchUser" lay-verify="required" lay-search>
                                <option value="">直接选择或搜索选择</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-input-block" style="margin-left: 300px">
                            <button type="submit" class="layui-btn" lay-submit lay-filter="dispatchForm">提交分配
                            </button>
                            <button type="reset" id="dispatchReset" class="layui-btn layui-btn-primary">重置</button>
                        </div>
                    </div>
                </form>
            </div>


        </div>
    </div>
</div>
<script type="text/html" id="bindTpl">
    <!-- 这里的 checked 的状态只是演示 -->
    <input type="checkbox" name="is_bind" value="{% verbatim %}{{ d.id }}{% endverbatim %}" title="绑定"
           lay-filter="bindCheckbox" {% verbatim %}{{ d.is_bind ? 'checked' : ''  }}{% endverbatim %} >
</script>
{% comment %} {% endcomment %}
{% csrf_token %}
<script type="text/javascript">
    layui.use(['layer', 'form', 'table', 'laytpl', 'laydate', 'upload'], function () {
        const layer = layui.layer,
            form = layui.form;
        const table = layui.table;
        const laydate = layui.laydate;
        const laytpl = layui.laytpl;
        const upload = layui.upload
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const headers = {
            "Accept": "application/json; charset=utf-8",
            "X-CSRFToken": csrftoken
        };

        lay('.test-item').each(function () {
            const date = new Date()
            const max = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()} ${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`
            laydate.render({
                elem: this,
                type: 'datetime',
                min: '2023-1-1 00:00:00',
                max: max
                , trigger: 'click'
            });
        });
        var globalCurrentPage = 1
        let op_col_width = 120
        let isAdmin = false;
        {% if request.session.user.role == 0 %}
            op_col_width = 180
            isAdmin = true
        {% endif %}

        /*表格渲染*/
        table.render({
            id: 'list',
            elem: '#list',
            url: '/api/account_id/list',
            page: true,
            toolbar: '#toolbar',
            cellMinWidth: 80,
            cols: [[
                {type: 'checkbox', fixed: 'left'},
                {field: 'id', title: '编号', width: 70, align: 'center', fixed: "left"},
                {field: 'account_id', title: 'ID', align: 'center', minWidth: 200},
                {field: 'country', title: '国家', align: 'center', sort: true},
                {field: 'age', title: '年龄', align: 'center', sort: true},
                {field: 'work', title: '工作', align: 'center', sort: true},
                {field: 'money', title: '收入', align: 'center', sort: true},
                {field: 'used', title: '使用状态', align: 'center', sort: true, templet: usedTemplate, minWidth: 110},
                {
                    field: 'is_bind',
                    title: '绑定状态',
                    align: 'center',
                    templet: "#bindTpl",
                    width: 120,
                    unresize: true
                },

                {% if request.session.user.role == 0 %}
                    {field: 'op_user__username', title: '上传人', align: 'center', sort: true, width: 200},
                {% endif %}
                {field: 'mark', title: '备注', align: 'center'},
                {field: 'create_time', title: '上传时间', align: 'center', sort: true, minWidth: 160},
                {field: 'update_time', title: '更新时间', align: 'center', sort: true, minWidth: 160},
                {field: 'action', title: '操作', fixed: 'right', toolbar: '#table_control', width: op_col_width}

            ]],
            defaultToolbar: ['filter'],
            limit: 100,
            limits: [10, 20, 50, 100, 500, 1000],
            done: function (res, curr, count) {
                globalCurrentPage = curr
            }
        });

        /*表格头工具监听*/
        table.on('toolbar(list)', function (obj) {
            const data = obj.data; //获得当前行数据
            const layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            if (layEvent === 'upload') {
                layer.open({
                    type: 1,
                    area: ['400px', '350px'],
                    title: ['ID上传', 'text-align:center;'],
                    content: $("#addForm")
                });
                initAddForm()
            } else if (layEvent === 'batch_upload') {
                layer.open({
                    type: 1,
                    area: ['400px', '300px'],
                    title: ['ID上传', 'text-align:center;'],
                    content: $("#uploadDialog")
                });
                initBatchUpload()
            } else if (layEvent === 'batch_export') {
                handleExport()
            } else if (layEvent === 'dispatch') {
                showDispatchDialog();
            } else if (layEvent === 'dispatch_all') {
                handleDispatch(true);
            } else if (layEvent === 'batch_used_state') {
                let checkStatus = table.checkStatus(obj.config.id);
                handleBatchUsedState(checkStatus)
            }
        });

        /*表格行工具监听*/
        table.on('tool(list)', function (obj) {
            const layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            if (layEvent === 'edit') {
                layer.open({
                    type: 1,
                    title: "修改数据",
                    area: ['600px', '600px'],
                    content: $("#editForm")
                });
                initEditForm(obj);
            } else if (layEvent === 'del') {
                handleDel(obj);
            } else if (layEvent === 'copy') {
                const text = obj.data.account_id
                {% comment %}if (navigator.clipboard) {
                    navigator.clipboard.writeText(text);
                }{% endcomment %}
                const copyipt = document.createElement("input");
                copyipt.setAttribute("value", text);
                document.body.appendChild(copyipt);
                copyipt.select();
                document.execCommand("copy");
                document.body.removeChild(copyipt);
                layer.msg("复制成功，内容为：" + text, {icon: 6});
            }
        });

        function initSearchForm() {
            form.on('submit(search)', function (data) {
                table.reload('list', {
                    page: {
                        curr: 1 //重新从第 1 页开始
                    },
                    where: data.field
                });
                return false;
            });
            form.render();
        }

        initSearchForm();

        function initAddForm() {
            form.val("addForm", {
                account_id: "",
            });

            form.on('submit(addSubmit)', function (massage) {
                console.log(massage)
                const load_index = layer.load();
                $.ajax({
                    url: '/api/account_id/upload',
                    type: 'POST',
                    headers: headers,
                    data: massage.field,
                    success: function (res) {
                        if (res.code >= 0) {
                            console.log("添加成功")
                            layer.closeAll('loading');
                            layer.load(2);
                            layer.msg("添加成功", {icon: 6});
                            setTimeout(function () {
                                table.reload("list");
                                layer.closeAll();//关闭所有的弹出层
                            }, 1000);
                        } else {
                            layer.msg(res.msg, {icon: 5})
                            layer.close(load_index)
                        }
                    },
                    error: function () {
                        layer.msg("请求失败", {icon: 5})
                        layer.close(load_index)
                    }
                });
                return false
            })

        }

        function initBatchUpload() {
            let layerId = 0
            const batchUpload = upload.render({
                elem: '#batchUpload',
                url: '/api/account_id/bat_upload',
                accept: 'file',
                field: 'file',
                headers: headers,
                exts: 'txt',
                auto: false,
                data: {
                    'filename': 'test.txt'
                },
                size: 30,
                bindAction: '#btnBatchUpload',
                before: function (obj) {
                    layerId = layer.load()
                    console.log("upload before");
                },
                choose: function (obj) {
                    batchUpload.config.elem.next()[0].value = '';
                    console.log("upload choose", obj);
                    let files = obj.pushFile();
                    console.log("upload choose files = ", files)
                    obj.preview(function (index, file, result) {
                        $('#uploadDemoView').removeClass('layui-hide');
                        $('#p_upload_preview')[0].innerHTML = `文件：${file.name}`
                        batchUpload.config.data.filename = file.name
                    });
                },
                done: function (res, index, upload) {
                    console.log(`upload done res = ${JSON.stringify(res)} index = ${index} upload = ${upload}`);
                    if (res.code < 0) {
                        // layer.closeAll('loading');
                        layer.close(layerId)
                        layer.msg(res.msg, {icon: 5})
                        return
                    }
                    // layer.closeAll();//关闭所有的弹出层
                    layer.close(layerId)
                    table.reload('list', {
                        page: {
                            curr: 1 //重新从第 1 页开始
                        }
                    });
                    $('#uploadDemoView').addClass('layui-hide');
                    layer.msg("上传成功", {icon: 6});
                    handleDispatch();
                },
                error: function (index, upload) {
                    console.log(`upload error index = ${index} upload = ${upload}`)
                    layer.msg("上传失败，请重试", {icon: 5})
                    // layer.closeAll('loading');
                    layer.close(layerId)
                }
            });
        }


        function initEditForm(obj) {
            const data = obj.data;
            console.log("data = ", data);
            form.val("editForm", {
                id: data.id,
                account_id: data.account_id,
                country: data.country,
                age: data.age,
                work: data.work,
                money: data.money,
                used: data.used + "",
                is_bind: data.is_bind || '0',
                mark: data.mark,
            });

            form.verify({
                account_id: function (value, item) {
                    if (!/^.+$/.test(value)) {
                        $(item).focus();
                        return 'ID不能为空';
                    }
                }
            });
            form.on('submit(editSubmit)', function (massage) {
                console.log("updatw = massage", massage)
                layer.load(1);
                $.ajax({
                    url: '/api/account_id/update',
                    type: 'POST',
                    headers: headers,
                    data: massage.field,
                    success: function (res) {
                        if (res.code >= 0) {
                            console.log("修改成功")
                            layer.closeAll('loading');
                            layer.load(2);
                            layer.msg("修改成功", {icon: 6});
                            setTimeout(function () {
                                layer.closeAll();//关闭所有的弹出层
                                table.reload("list", {
                                    page: {
                                        curr: globalCurrentPage
                                    }
                                });//修改成功修改表格数据不进行跳转
                            }, 1000);
                        } else {
                            layer.msg("修改失败", {icon: 5});
                        }
                    }
                });
                return false
            });
        }

        function handleDel(obj) {
            layer.confirm('确定删除吗？', function (index) {
                layer.close(index);
                const index2 = layer.load(0);
                $.ajax({
                    url: "/api/account_id/del",
                    data: {id: obj.data.id, account_id: obj.data.account_id},
                    type: "post",
                    headers: headers,
                    dataType: "JSON",
                    success: function (msg) {
                        if (msg.code === 0) {
                            layer.msg(msg.msg);
                            setTimeout(function () {
                                layer.closeAll();//关闭所有的弹出层2
                                table.reload("list", {
                                    page: {
                                        curr: globalCurrentPage
                                    }
                                });//修改成功修改表格数据不进行跳转
                            }, 1000);
                            return;
                        }
                        layer.msg(msg.msg, {icon: 5});
                    },
                    error: function () {
                        layer.msg("请求失败", {icon: 5})
                    },
                    complete() {
                        layer.close(index2);
                    }
                });
            });
        }

        function handleExport() {
            const xhr = new XMLHttpRequest();
            xhr.open('get', "/api/account_id/export", true); // 也可以使用POST方式，根据接口
            xhr.responseType = "blob"; // 返回类型blob
            // 定义请求完成的处理函数，请求前也可以增加加载框/禁用下载按钮逻辑
            xhr.onload = function () {
                // 请求完成
                if (this.status === 200) {
                    // 返回200
                    const blob = new Blob([this.response], {
                        type: "application/vnd.ms-excel"
                    });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    $("body").append(a); // 修复firefox中无法触发click
                    a.click();
                    $(a).remove();
                } else if (this.status === 404 || this.status === 500) {
                    console.log("404 response = ", this.response)
                    layer.msg("导出失败，" + this.status, {icon: 5})
                }
            };
            xhr.timeout = 1000 * 60 * 60 * 24; //将超时时间设置为1天
            xhr.ontimeout = function () { //请求终止时，会执行ontimeout事件处理程序
                layer.msg("导出失败，请求超时", {icon: 5})
            }
            // 发送ajax请求
            xhr.send()
        }

        function handleDispatch(isAll = false) {
            layer.confirm('确定分发数据到用户吗？', function (index) {
                layer.close(index);
                const index2 = layer.load(0);
                $.ajax({
                    url: "/api/account_id/dispatcher",
                    type: "post",
                    data: {
                        'isAll': isAll,
                    },
                    headers: headers,
                    dataType: "JSON",
                    success: function (msg) {
                        console.log("msg = ", msg);
                        if (msg.code === 0) {
                            layer.msg(msg.msg, {icon: 6});
                            setTimeout(function () {
                                layer.close(index2);
                                table.reload("list", {
                                    page: {
                                        curr: globalCurrentPage
                                    }
                                });
                            }, 1000);
                            return;
                        }
                        layer.msg(msg.msg, {icon: 5});
                    },
                    error: function () {
                        layer.msg("请求失败", {icon: 5})
                    },
                    complete() {
                        layer.close(index2);
                    }
                });
            });
        }

        function handleBatchUsedState(checkStatus) {
            if (checkStatus.data.length === 0) {
                layer.msg("请至少选择一个列表项", {icon: 5});
                return
            }
            console.log("checkStatus = " + JSON.stringify(checkStatus))
            let ids = checkStatus.data.map((data) => data.id)
            layer.open({
                type: 1,
                title: "请选择状态",
                area: ['400px', '300px'],
                content: $("#batchUpdateUsedStateForm")
            });
            form.val("batchUpdateUsedStateForm", {
                used: ""
            });

            form.verify({
                used: function (value, item) {
                    if (value === "" || value === undefined) {
                        $(item).focus();
                        return "请选择一个状态"
                    }
                }
            });
            form.on('submit(usedSubmit)', function (massage) {
                console.log("updatw = massage", massage)
                layer.load(1);
                let formData = {
                    "used": massage.field.used,
                    "ids": ids.join(",")
                }

                $.ajax({
                    url: '/api/account_id/bat_used_update',
                    type: 'POST',
                    headers: headers,
                    data: formData,
                    success: function (res) {
                        if (res.code >= 0) {
                            console.log("修改成功")
                            layer.closeAll('loading');
                            layer.load(2);
                            layer.msg("修改成功", {icon: 6});
                            setTimeout(function () {
                                layer.closeAll();//关闭所有的弹出层
                                table.reload("list", {
                                    page: {
                                        curr: globalCurrentPage
                                    }
                                });//修改成功修改表格数据不进行跳转
                            }, 1000);
                        } else {
                            layer.msg("修改失败", {icon: 5});
                        }
                    }
                });
                return false
            });
        }

        function usedTemplate(res) {
            if (res.used === 1) {
                return `<span class="layui-badge layui-bg-green">已使用</span>`
            } else if (res.used === 2) {
                return `<span class="layui-badge">无效</span>`
            } else {
                return `<span class="layui-badge layui-bg-orange">未使用</span>`
            }
        }

        function bindTemplate(res) {
            if (res.is_bind) {
                return `<span class="layui-badge layui-bg-blue">已绑定</span>`
            } else {
                return `<span class="layui-badge layui-bg-gray">未绑定</span>`
            }
        }

        (function initUserList() {
            $.ajax({
                url: '/api/user_simple_list',
                success: function (res) {
                    if (res.code >= 0) {
                        let data = res.data;
                        let selectElements = $("select[name='op_user_select']");
                        for (let j = 0; j < selectElements.length; j++) {
                            for (let i = 0; i < data.length; i++) {
                                let item = data[i];
                                selectElements.eq(j).append(
                                    `<option value="${item.id}">${item.username}</option>`
                                );
                            }
                        }
                        form.render('select');
                    } else {
                        console.log("策略列表，错误：", res.msg)
                    }
                }
            });
        })();

        //滚动条
        jQuery(".page-main").scrollbar();
        form.on('checkbox(bindCheckbox)', function (obj) {
            const originChecked = !obj.elem.checked
            const newChecked = obj.elem.checked
            const id = this.value;
            const that = this;

            function changedCheck(checked) {
                $(that).prop('checked', checked)
                form.render("checkbox")
            }

            changedCheck(originChecked);

            function updateBindStatus() {
                const loadingIndex = layer.load(0);
                $.ajax({
                    url: "/api/account_id/update_bind",
                    method: 'post',
                    dataType: "JSON",
                    headers: headers,
                    data: {
                        "id": id,
                        "bind": newChecked,
                        "back_type": "1"
                    },
                    success: function (res) {
                        if (res.code === 0) {
                            console.log("result ==> ", newChecked == res.data)
                            changedCheck(newChecked)
                            layer.msg(res.msg, {icon: 6});
                            setTimeout(function () {
                                table.reload("list", {
                                    page: {
                                        curr: globalCurrentPage
                                    }
                                });
                            }, 1000);
                            return;
                        }
                        layer.msg(res.msg, {icon: 5});
                    }, error: function () {
                        layer.msg("请求失败", {icon: 5})
                    },
                    complete() {
                        layer.close(loadingIndex);
                        layer.closeAll();
                    }
                });
            }

            layer.confirm(newChecked ? '确定绑定吗？(绑定仅设置状态)' : '确定解除绑定吗？(解除绑定后将删除用户绑定数据)', function (index) {
                layer.close(index);
                updateBindStatus()
            });
        });
        const dispatchCols = [[
            {type: 'checkbox', fixed: 'left'},
            {field: 'id', title: '编号', width: 70, align: 'center'},
            {field: 'account_id', title: '账号', align: 'center', minWidth: 200},
            {field: 'is_bind', title: '绑定状态', align: 'center', sort: true, templet: bindTemplate, minWidth: 110},
            {field: 'op_user__username', title: '上传人', align: 'center', sort: true},
            {field: 'create_time', title: '上传时间', align: 'center', sort: true, minWidth: 160},
        ]]
        var dispatchListCurPage = 1
        var allDataIds = []
        table.render({
            id: 'dispatchList',
            elem: "#dispatchList",
            url: '/api/account_id/unusedList',
            height: 340,
            page: true,
            cols: dispatchCols,
            limit: 20,
            limits: [20, 30, 50],
            done: function (res, curr) {
                dispatchListCurPage = curr
                allDataIds = res.data.map((item) => item.id)
            }
        });

        function showDispatchDialog() {
            table.reload("dispatchList");
            $("#dispatchSearch").on('click', function () {
                const dispatchId = $("#dispatchReload").val()
                table.reload('dispatchList', {
                    page: {
                        curr: 1 //重新从第 1 页开始
                    },
                    where: {
                        "dispatchId": dispatchId
                    }
                });
            });

            $.ajax({
                url: "/api/user_simple_list2?back_type=1",
                type: 'get',
                success: function (res) {
                    if (res.code < 0) {
                        console.error("获取用户列表出错", res.msg)
                        return
                    }
                    // {id: id, username:username}
                    const userDataList = res.data;
                    let selectElements = $("select[name='dispatchUser']");
                    for (let j = 0; j < selectElements.length; j++) {
                        const elem = selectElements.eq(j)
                        elem.children().remove()
                        elem.append(`<option value="">直接选择或搜索选择</option>`)
                        for (let i = 0; i < userDataList.length; i++) {
                            let item = userDataList[i];
                            selectElements.eq(j).append(
                                `<option value="${item.id}">${item.username}</option>`
                            );
                        }
                    }
                    form.render('select');
                }
            })

            let checkIds = new Set()

            table.on("checkbox(dispatchList)", function (obj) {
                if (obj.type === 'all') {
                    if (obj.checked) {
                        allDataIds.forEach((item) => {
                            checkIds.add(item)
                        })
                    } else {
                        checkIds.clear()
                    }
                    console.log("全选数据 = ", Array.from(checkIds))
                    return
                }
                if (obj.checked) {
                    checkIds.add(obj.data.id)
                } else {
                    checkIds.delete(obj.data.id)
                }
                console.log("checkIds = ", checkIds)
            })
            form.val("dispatchForm", {
                dispatchUser: ""
            });

            $("#dispatchReset").on("click", function () {
                console.log("重置")
                table.reload("dispatchList");
            })

            form.on("submit(dispatchForm)", function (data) {
                let field = data.field;
                let userid = field.dispatchUser;
                console.log("表单提交, userid = ", userid, " 选中数据 = ", JSON.stringify(checkIds));
                if (!userid || userid === '') {
                    layer.msg("分配失败，请选择一个用户", {icon: 5})
                    return false
                }
                if (checkIds.size === 0) {
                    layer.msg("分配失败，请至少选择一个数据", {icon: 5})
                    return false
                }
                const loadingIndex = layer.load(0);
                $.ajax({
                    url: "/api/account_id/dispatch",
                    type: 'post',
                    headers: headers,
                    dataType: "JSON",
                    data: {
                        "user_id": userid,
                        'aids': Array.from(checkIds).join(",")
                    },
                    success: function (res) {
                        if (res.code < 0) {
                            layer.msg("分配失败，" + res.msg, {icon: 5})
                            return
                        }
                        layer.closeAll();//关闭所有的弹出层2
                        layer.msg(res.msg, {icon: 1});
                        table.reload("dispatchList");
                        table.reload("list");
                    },
                    complete: function () {
                        layer.close(loadingIndex)
                    }
                })

                return false
            });

            layer.open({
                type: 1,
                title: "未使用账号数据",
                area: ['900px', '600px'],
                content: $("#dispatchDialog")
            });

        }
    });
</script>
</body>
</html>